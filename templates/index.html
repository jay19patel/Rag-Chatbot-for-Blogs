<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Blog Creator Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .chat-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .chat-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .chat-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .chat-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
        .message-enter {
            animation: messageSlideIn 0.3s ease-out;
        }
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-80 bg-white shadow-lg border-r border-gray-200 flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-robot text-blue-600 mr-3"></i>
                    AI Blog Creator
                </h1>
                <p class="text-sm text-gray-600 mt-1">Create amazing blogs with AI assistance</p>
            </div>

            <!-- Recent Blogs / Search -->
            <div class="flex-1 overflow-y-auto chat-scrollbar">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 id="sectionTitle" class="text-sm font-semibold text-gray-700">Recent Blogs</h3>
                        <button id="toggleSearchBtn" class="text-xs text-blue-600 hover:text-blue-800">
                            <i class="fas fa-search mr-1"></i>
                            Search
                        </button>
                    </div>

                    <!-- Search Input (Hidden by default) -->
                    <div id="searchContainer" class="hidden mb-3">
                        <div class="relative">
                            <input
                                type="text"
                                id="searchInput"
                                placeholder="Search blogs..."
                                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent pl-9"
                            >
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                            <button id="clearSearchBtn" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 hidden">
                                <i class="fas fa-times text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Content Container -->
                    <div id="contentContainer" class="space-y-2">
                        <!-- Blogs will be populated here -->
                    </div>

                    <!-- Loading indicator -->
                    <div id="loadingIndicator" class="hidden text-center py-4">
                        <i class="fas fa-spinner fa-spin text-gray-400"></i>
                        <p class="text-xs text-gray-500 mt-1">Loading...</p>
                    </div>

                    <!-- No results message -->
                    <div id="noResultsMessage" class="hidden text-center py-4">
                        <i class="fas fa-search text-gray-300 text-2xl"></i>
                        <p class="text-sm text-gray-500 mt-2">No blogs found</p>
                    </div>
                </div>
            </div>

            <!-- New Chat Button -->
            <div class="p-4 border-t border-gray-200">
                <button id="newChatBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i>
                    New Chat
                </button>
            </div>
        </div>

        <!-- Main Chat Container -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <div class="bg-white shadow-sm border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800" id="chatTitle">New Blog Creation</h2>
                        <p class="text-sm text-gray-600">Ask me anything about creating your blog</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                            <i class="fas fa-circle text-green-500 mr-1"></i>
                            Online
                        </span>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="flex-1 overflow-y-auto chat-scrollbar bg-gray-50 p-4" id="chatMessages">
                <!-- Welcome Message -->
                <div class="flex items-start space-x-3 mb-6">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm max-w-lg">
                        <p class="text-gray-800">Hello! I'm your AI blog creation assistant. I can help you:</p>
                        <ul class="mt-2 text-sm text-gray-600 space-y-1">
                            <li>• Create engaging blog posts on any topic</li>
                            <li>• Generate ideas and outlines</li>
                            <li>• Write, edit, and improve content</li>
                            <li>• Save your blogs to the database</li>
                        </ul>
                        <p class="mt-3 text-gray-800">What kind of blog would you like to create today?</p>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="bg-white border-t border-gray-200 p-4">
                <div class="flex items-end space-x-4">
                    <div class="flex-1">
                        <div class="relative">
                            <textarea
                                id="messageInput"
                                placeholder="Type your message here... (e.g., 'Create a blog about AI in healthcare')"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none pr-12"
                                rows="1"
                                style="min-height: 44px; max-height: 120px;"
                            ></textarea>
                            <button
                                id="sendBtn"
                                class="absolute right-2 bottom-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                <i class="fas fa-paper-plane text-sm"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Press Shift+Enter for new line, Enter to send</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blog Preview Modal -->
    <div id="blogModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">Blog Preview</h3>
                    <button id="closeBlogModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]" id="blogContent">
                    <!-- Blog content will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // AI Blog Creator Chat Application
        class ChatApp {
            constructor() {
                this.currentSessionId = 'default';
                this.isLoading = false;
                this.recentBlogs = [];
                this.isSearchMode = false;
                this.searchTimeout = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadRecentBlogs();
                this.autoResizeTextarea();
            }

            setupEventListeners() {
                const messageInput = document.getElementById('messageInput');
                const sendBtn = document.getElementById('sendBtn');
                const newChatBtn = document.getElementById('newChatBtn');
                const closeBlogModal = document.getElementById('closeBlogModal');
                const toggleSearchBtn = document.getElementById('toggleSearchBtn');
                const searchInput = document.getElementById('searchInput');
                const clearSearchBtn = document.getElementById('clearSearchBtn');

                // Message input events
                messageInput.addEventListener('input', () => {
                    sendBtn.disabled = !messageInput.value.trim();
                    this.autoResizeTextarea();
                });

                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Search functionality
                toggleSearchBtn.addEventListener('click', () => this.toggleSearchMode());

                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim();
                    clearSearchBtn.classList.toggle('hidden', !query);

                    if (this.searchTimeout) {
                        clearTimeout(this.searchTimeout);
                    }

                    this.searchTimeout = setTimeout(() => {
                        if (query) {
                            this.performSearch(query);
                        } else {
                            this.showNoResults(false);
                            this.loadRecentBlogs();
                        }
                    }, 300);
                });

                clearSearchBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    clearSearchBtn.classList.add('hidden');
                    this.loadRecentBlogs();
                    searchInput.focus();
                });

                // Button events
                sendBtn.addEventListener('click', () => this.sendMessage());
                newChatBtn.addEventListener('click', () => this.startNewChat());
                closeBlogModal.addEventListener('click', () => this.closeBlogModal());

                // Modal events
                document.getElementById('blogModal').addEventListener('click', (e) => {
                    if (e.target.id === 'blogModal') {
                        this.closeBlogModal();
                    }
                });
            }

            autoResizeTextarea() {
                const textarea = document.getElementById('messageInput');
                textarea.style.height = 'auto';
                const newHeight = Math.min(textarea.scrollHeight, 120);
                textarea.style.height = newHeight + 'px';
            }

            async sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();

                if (!message || this.isLoading) return;

                this.addMessage(message, 'user');
                messageInput.value = '';
                messageInput.style.height = '44px';
                document.getElementById('sendBtn').disabled = true;

                this.showTypingIndicator();
                this.isLoading = true;

                try {
                    const response = await fetch('/api/v1/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            session_id: this.currentSessionId
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    this.hideTypingIndicator();
                    this.addMessage(data.response, 'ai');

                } catch (error) {
                    this.hideTypingIndicator();
                    this.addMessage('Sorry, I encountered an error. Please try again.', 'ai', true);
                    console.error('Error sending message:', error);
                } finally {
                    this.isLoading = false;
                }
            }

            addMessage(content, sender, isError = false) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start space-x-3 mb-4 message-enter`;

                if (sender === 'user') {
                    messageDiv.innerHTML = `
                        <div class="flex-1 flex justify-end">
                            <div class="bg-blue-600 text-white rounded-lg p-4 shadow-sm max-w-lg">
                                <p class="whitespace-pre-wrap">${this.escapeHtml(content)}</p>
                            </div>
                        </div>
                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-blue-600 text-sm"></i>
                        </div>
                    `;
                } else {
                    const bgColor = isError ? 'bg-red-50 border border-red-200' : 'bg-white';
                    const textColor = isError ? 'text-red-800' : 'text-gray-800';

                    messageDiv.innerHTML = `
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="${bgColor} rounded-lg p-4 shadow-sm max-w-2xl">
                            <div class="${textColor} whitespace-pre-wrap">${this.formatMessage(content)}</div>
                        </div>
                    `;
                }

                chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            formatMessage(content) {
                let formatted = this.escapeHtml(content);
                formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                formatted = formatted.replace(/^### (.*$)/gm, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>');
                formatted = formatted.replace(/^## (.*$)/gm, '<h2 class="text-xl font-semibold mt-4 mb-2">$1</h2>');
                formatted = formatted.replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold mt-4 mb-2">$1</h1>');
                formatted = formatted.replace(/^\* (.*$)/gm, '<li class="ml-4">• $1</li>');
                formatted = formatted.replace(/^- (.*$)/gm, '<li class="ml-4">• $1</li>');
                return formatted;
            }

            showTypingIndicator() {
                const chatMessages = document.getElementById('chatMessages');
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'flex items-start space-x-3 mb-4';
                typingDiv.innerHTML = `
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-white rounded-lg p-4 shadow-sm">
                        <div class="flex space-x-1">
                            <div class="typing-indicator"></div>
                            <div class="typing-indicator"></div>
                            <div class="typing-indicator"></div>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(typingDiv);
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            scrollToBottom() {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            startNewChat() {
                this.currentSessionId = 'session_' + Date.now();
                document.getElementById('chatMessages').innerHTML = this.getWelcomeMessage();
                document.getElementById('chatTitle').textContent = 'New Blog Creation';
            }

            async loadRecentBlogs() {
                this.showLoading(true);
                try {
                    console.log('Fetching recent blogs...');
                    const response = await fetch('/api/v1/blogs?limit=10');

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('API Response:', data);

                    this.recentBlogs = data.blogs || [];

                    if (this.recentBlogs.length === 0) {
                        this.showNoResults(true, 'No blogs found in database');
                    } else {
                        this.displayBlogs(this.recentBlogs);
                    }
                } catch (error) {
                    console.error('Error loading recent blogs:', error);
                    this.showNoResults(true, `Failed to load blogs: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }

            toggleSearchMode() {
                this.isSearchMode = !this.isSearchMode;
                const searchContainer = document.getElementById('searchContainer');
                const toggleBtn = document.getElementById('toggleSearchBtn');
                const sectionTitle = document.getElementById('sectionTitle');
                const searchInput = document.getElementById('searchInput');

                if (this.isSearchMode) {
                    searchContainer.classList.remove('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-times mr-1"></i>Cancel';
                    sectionTitle.textContent = 'Search Blogs';
                    searchInput.focus();
                } else {
                    searchContainer.classList.add('hidden');
                    toggleBtn.innerHTML = '<i class="fas fa-search mr-1"></i>Search';
                    sectionTitle.textContent = 'Recent Blogs';
                    searchInput.value = '';
                    document.getElementById('clearSearchBtn').classList.add('hidden');
                    this.loadRecentBlogs();
                }
            }

            async performSearch(query) {
                this.showLoading(true);
                try {
                    console.log('Searching for:', query);
                    const response = await fetch(`/api/v1/blogs/search?q=${encodeURIComponent(query)}&limit=10`);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log('Search results:', data);

                    if (!data.results || data.results.length === 0) {
                        this.showNoResults(true, `No blogs found for "${query}"`);
                    } else {
                        this.displayBlogs(data.results, true);
                    }
                } catch (error) {
                    console.error('Error searching blogs:', error);
                    this.showNoResults(true, `Search failed: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }

            displayBlogs(blogs, isSearchResult = false) {
                const container = document.getElementById('contentContainer');
                container.innerHTML = '';

                if (!blogs || blogs.length === 0) {
                    this.showNoResults(true, 'No blogs found');
                    return;
                }

                blogs.forEach(blog => {
                    const blogDiv = document.createElement('div');
                    blogDiv.className = 'p-3 rounded-lg cursor-pointer transition-colors duration-200 hover:bg-gray-50 border border-gray-100 hover:border-gray-200';

                    const date = blog.created_at ? new Date(blog.created_at).toLocaleDateString() : 'Unknown date';
                    const title = blog.title || 'Untitled Blog';
                    const preview = blog.excerpt || (blog.content ? blog.content.substring(0, 80) + (blog.content.length > 80 ? '...' : '') : 'No content available');

                    blogDiv.innerHTML = `
                        <div class="text-sm font-medium text-gray-800 truncate">${this.escapeHtml(title)}</div>
                        <div class="text-xs text-gray-600 mt-1 truncate">${this.escapeHtml(preview)}</div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="text-xs text-gray-500">${date}</div>
                            ${isSearchResult && blog.relevance_score ?
                                `<div class="text-xs text-blue-600">${Math.round(blog.relevance_score * 100)}% match</div>` :
                                ''
                            }
                        </div>
                        ${blog.category ? `<div class="text-xs text-purple-600 mt-1">#${blog.category}</div>` : ''}
                    `;

                    blogDiv.addEventListener('click', () => {
                        this.loadBlogToChat(blog);
                    });

                    container.appendChild(blogDiv);
                });

                this.showNoResults(false);
            }

            async loadBlogToChat(blog) {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = this.getWelcomeMessage();

                if (blog.blog_id && !blog.content) {
                    this.addMessage(`Show me the blog: "${blog.title}"`, 'user');
                    this.showTypingIndicator();

                    try {
                        const blogInfo = `**${blog.title}**\n\n${blog.excerpt || 'No content preview available'}\n\nBlog ID: ${blog.blog_id}\nCategory: ${blog.category || 'Uncategorized'}\nCreated: ${blog.created_at ? new Date(blog.created_at).toLocaleDateString() : 'Unknown'}`;

                        this.hideTypingIndicator();
                        this.addMessage(blogInfo, 'ai');
                        this.addMessage('I can help you edit this blog, create a new version, or discuss its content. What would you like to do?', 'ai');
                    } catch (error) {
                        this.hideTypingIndicator();
                        this.addMessage('Sorry, I could not load the full blog content.', 'ai', true);
                    }
                } else {
                    this.addMessage(`Show me this blog: "${blog.title}"`, 'user');
                    this.addMessage(blog.content || blog.excerpt || 'Blog content not available', 'ai');
                }

                document.getElementById('chatTitle').textContent = blog.title || 'Blog Discussion';
                this.currentSessionId = 'blog_' + (blog.blog_id || blog._id || Date.now());
            }

            showLoading(show) {
                const loadingIndicator = document.getElementById('loadingIndicator');
                const contentContainer = document.getElementById('contentContainer');

                if (show) {
                    loadingIndicator.classList.remove('hidden');
                    contentContainer.classList.add('hidden');
                } else {
                    loadingIndicator.classList.add('hidden');
                    contentContainer.classList.remove('hidden');
                }
            }

            showNoResults(show, message = 'No blogs found') {
                const noResultsMessage = document.getElementById('noResultsMessage');
                const contentContainer = document.getElementById('contentContainer');

                if (show) {
                    noResultsMessage.classList.remove('hidden');
                    noResultsMessage.querySelector('p').textContent = message;
                    contentContainer.classList.add('hidden');
                } else {
                    noResultsMessage.classList.add('hidden');
                    contentContainer.classList.remove('hidden');
                }
            }

            closeBlogModal() {
                document.getElementById('blogModal').classList.add('hidden');
            }

            getWelcomeMessage() {
                return `
                    <div class="flex items-start space-x-3 mb-6">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm max-w-lg">
                            <p class="text-gray-800">Hello! I'm your AI blog creation assistant. I can help you:</p>
                            <ul class="mt-2 text-sm text-gray-600 space-y-1">
                                <li>• Create engaging blog posts on any topic</li>
                                <li>• Generate ideas and outlines</li>
                                <li>• Write, edit, and improve content</li>
                                <li>• Save your blogs to the database</li>
                            </ul>
                            <p class="mt-3 text-gray-800">What kind of blog would you like to create today?</p>
                        </div>
                    </div>
                `;
            }
        }

        // Initialize the chat app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ChatApp();
        });
    </script>
</body>
</html>